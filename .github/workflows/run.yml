name: Playwright Automation (300 Accounts)

# 1. Manual Trigger Only
on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # Increased to 2 hours for 50 accounts per shard

    # === CONFIGURATION FOR 300 ACCOUNTS (50 PER COMPUTER) ===
    # Math: 300 Accounts / 50 per Comp = 6 Computers needed.
    strategy:
      fail-fast: false
      matrix:
        # We launch 6 computers (Indexes 0 to 5)
        shard: [0, 1, 2, 3, 4, 5]
    # =======================================================

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create Accounts File
        # Ensure secret 'ACCOUNTS_CSV' has all 300 accounts
        run: echo "${{ secrets.ACCOUNTS_CSV }}" > accounts.csv

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium

      - name: Run script (Shard ${{ matrix.shard }})
        env:
          PYTHONUNBUFFERED: 1
          # Pass the shard index (0 to 5)
          SHARD_INDEX: ${{ matrix.shard }}
          # Set this to 6 so the script splits the 300 accounts into 6 chunks
          TOTAL_SHARDS: 6
        run: python -u account_automation.py

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-shard-${{ matrix.shard }}
          path: |
            account_balances.csv
            failed_accounts.csv
            progress.json
            screenshots/
